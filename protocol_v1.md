# Protocol Specification V1.0 (VIP Afterparty)

## Meta
- **protocolVersion:** "1.0"
- **Transport:** HTTPS
- **Encoding:** JSON (UTF-8)
- **Time Format:** ISO 8601 UTC (where applicable)
- **Client Idempotency:** `clientRequestId` (UUIDv4) per spin request
- **Server Round ID:** `roundId` (UUIDv4) generated by server for audit

## Authentication / Player Identity (MVP)
This protocol assumes the platform (RGS host) supplies the player identity.
- **Required header:** `X-Player-Id: <string>`
- **Optional header:** `Authorization: Bearer <token>` (may be ignored in MVP)

If `X-Player-Id` is missing, server MUST return `INVALID_REQUEST`.

---

## 1) Init — `GET /init`

Used to bootstrap client configuration and optionally restore unfinished round state.

### Request
Headers:
- `X-Player-Id` (required)

### Response (200)
```json
{
  "protocolVersion": "1.0",
  "configuration": {
    "currency": "USD",
    "allowedBets": [0.10, 0.20, 0.50, 1.00, 2.00, 5.00, 10.00],
    "enableBuyFeature": true,
    "buyFeatureCostMultiplier": 100,
    "enableTurbo": true,
    "enableHypeModeAnteBet": true,
    "hypeModeCostIncrease": 0.25
  },
  "restoreState": null
}
```

### restoreState (if present)

If the player has an unfinished free-spins state on the server, restoreState MUST be returned:

```json
{
  "mode": "FREE_SPINS",
  "spinsRemaining": 7,
  "heatLevel": 4
}
```

Notes:
- Server is authoritative for restore. Client must not invent state.

---

## 2) Spin — `POST /spin`

### Request

Headers:
- `X-Player-Id` (required)

Body:

```json
{
  "clientRequestId": "uuid-v4-generated-by-client",
  "betAmount": 1.00,
  "mode": "NORMAL",
  "hypeMode": false
}
```

Fields:
- `clientRequestId` (string, UUIDv4) — idempotency key
- `betAmount` (number) — must be one of allowedBets from /init
- `mode` (string) — "NORMAL" or "BUY_FEATURE"
- `hypeMode` (boolean) — when true, server applies ante-bet rules from CONFIG.md / GAME_RULES.md

### Success Response (200)

```json
{
  "protocolVersion": "1.0",
  "roundId": "uuid-v4-generated-by-server",
  "context": {
    "currency": "USD"
  },
  "outcome": {
    "totalWin": 2.50,
    "totalWinX": 2.50,
    "isCapped": false,
    "capReason": null
  },
  "events": [
    {
      "type": "reveal",
      "grid": [[1,2,3],[1,2,3],[1,2,3],[1,2,3],[1,2,3]]
    },
    {
      "type": "spotlightWilds",
      "positions": [2, 7],
      "count": 2
    },
    {
      "type": "winLine",
      "lineId": 5,
      "amount": 0.50,
      "winX": 0.50
    },
    {
      "type": "eventStart",
      "eventType": "rage",
      "reason": "deadspins",
      "durationSpins": 2
    },
    {
      "type": "heatUpdate",
      "level": 1
    },
    {
      "type": "enterFreeSpins",
      "count": 10
    },
    {
      "type": "bonusEnd",
      "bonusType": "freespins",
      "finalePath": "multiplier",
      "totalWinX": 25.0
    },
    {
      "type": "eventEnd",
      "eventType": "rage"
    },
    {
      "type": "winTier",
      "tier": "big",
      "winX": 25.0
    }
  ],
  "nextState": {
    "mode": "BASE",
    "spinsRemaining": 0,
    "heatLevel": 1
  }
}
```

### Notes on fields
- `totalWinX` is defined as totalWin / baseBet. Base bet is betAmount (not including ante surcharge from hype mode).
- `capReason` values:
  - `"max_win_base"`
  - `"max_win_bonus"`
  - `"max_exposure"`

### Event ordering (MUST)
Client MUST play events in the order returned.
Typical ordering:
1. reveal
2. optional base modifiers (spotlightWilds)
3. win presentation (winLine / winWays if used)
4. mode transitions (enterFreeSpins)
5. progression (heatUpdate)
6. bonus closure (bonusEnd) if applicable
7. event boundaries (eventStart/eventEnd) if applicable
8. celebration (winTier) if applicable

---

## 3) Error Response (all endpoints)

Server MUST return machine-readable error body:

```json
{
  "protocolVersion": "1.0",
  "error": {
    "code": "INVALID_BET",
    "message": "Bet amount not allowed.",
    "recoverable": false
  }
}
```

- Client MUST ignore unknown fields (forward compatibility).
- HTTP status MUST match error_codes.md.

---

## 4) Event Payload Contract (MUST)

This section defines required fields for event objects in `events[]`.

### 4.1 reveal

```json
{ "type": "reveal", "grid": [[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]] }
```

### 4.2 winLine

```json
{ "type": "winLine", "lineId": 1, "amount": 1.25, "winX": 1.25 }
```

### 4.3 enterFreeSpins

```json
{ "type": "enterFreeSpins", "count": 10 }
```

### 4.4 heatUpdate

```json
{ "type": "heatUpdate", "level": 1 }
```

### 4.5 eventStart / eventEnd

```json
{ "type": "eventStart", "eventType": "boost", "reason": "smallwins", "durationSpins": 3 }
```

```json
{ "type": "eventEnd", "eventType": "boost" }
```

`eventType` MUST be one of: `boost|rage|explosive|bonus|finale`

### 4.6 spotlightWilds

```json
{ "type": "spotlightWilds", "positions": [0, 7, 12], "count": 3 }
```

Positions are 0-based flattened indices for a 5x3 grid:
- `index = reelIndex * 3 + rowIndex`

### 4.7 winTier

```json
{ "type": "winTier", "tier": "mega", "winX": 75.0 }
```

`tier` MUST be one of: `none|big|mega|epic`

### 4.8 bonusEnd

```json
{ "type": "bonusEnd", "bonusType": "freespins", "finalePath": "upgrade", "totalWinX": 38.0 }
```

`finalePath` MUST be one of: `upgrade|multiplier|standard`

---

## 5) Compatibility Rules (MUST)
- Unknown fields MUST be ignored by the client.
- Unknown event types MUST be ignored by the client (log + continue).
- Server MUST always include `protocolVersion` in responses.
