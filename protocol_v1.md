# Protocol Specification V1.0 (VIP Afterparty)

## Meta
- **protocolVersion:** "1.0"
- **Transport:** HTTPS (production), HTTP allowed for local dev
- **Encoding:** JSON (UTF-8)
- **Time Format:** ISO 8601 UTC (where applicable)
- **Client Idempotency:** `clientRequestId` (UUIDv4) per spin request
- **Server Round ID:** `roundId` (UUIDv4) generated by server for audit

## Authentication / Player Identity (MVP)
This protocol assumes the platform (RGS host) supplies the player identity.
- **Required header:** `X-Player-Id: <string>`
- **Optional header:** `Authorization: Bearer <token>` (may be ignored in MVP)

If `X-Player-Id` is missing, server MUST return `INVALID_REQUEST`.

---

## 1) Init — `GET /init`

Used to bootstrap client configuration and optionally restore unfinished round state.

### Request
Headers:
- `X-Player-Id` (required)

### Response (200)
```json
{
  "protocolVersion": "1.0",
  "configuration": {
    "currency": "USD",
    "allowedBets": [0.10, 0.20, 0.50, 1.00, 2.00, 5.00, 10.00],
    "enableBuyFeature": true,
    "buyFeatureCostMultiplier": 100,
    "enableTurbo": true,
    "enableHypeModeAnteBet": true,
    "hypeModeCostIncrease": 0.25
  },
  "restoreState": null
}
```

### restoreState (if present)

If the player has an unfinished free-spins state on the server, restoreState MUST be returned:

```json
{
  "mode": "FREE_SPINS",
  "spinsRemaining": 7,
  "heatLevel": 4
}
```

Notes:
- Server is authoritative for restore. Client must not invent state.

---

## 2) Spin — `POST /spin`

### Request

Headers:
- `X-Player-Id` (required)

Body:

```json
{
  "clientRequestId": "uuid-v4-generated-by-client",
  "betAmount": 1.00,
  "mode": "NORMAL",
  "hypeMode": false
}
```

Fields:
- `clientRequestId` (string, UUIDv4) — idempotency key
- `betAmount` (number) — must be one of allowedBets from /init
- `mode` (string) — "NORMAL" or "BUY_FEATURE"
- `hypeMode` (boolean) — when true, server applies ante-bet rules from CONFIG.md / GAME_RULES.md

### Success Response (200)

```json
{
  "protocolVersion": "1.0",
  "roundId": "uuid-v4-generated-by-server",
  "context": {
    "currency": "USD"
  },
  "outcome": {
    "totalWin": 25.0,
    "totalWinX": 25.0,
    "isCapped": false,
    "capReason": null
  },
  "events": [
    {
      "type": "eventStart",
      "eventType": "rage",
      "reason": "deadspins",
      "durationSpins": 2
    },
    {
      "type": "reveal",
      "grid": [[1,2,3],[1,2,3],[1,2,3],[1,2,3],[1,2,3]]
    },
    {
      "type": "spotlightWilds",
      "positions": [2, 7],
      "count": 2
    },
    {
      "type": "winLine",
      "lineId": 5,
      "amount": 25.0,
      "winX": 25.0
    },
    {
      "type": "heatUpdate",
      "level": 1
    },
    {
      "type": "winTier",
      "tier": "big",
      "winX": 25.0
    }
  ],
  "nextState": {
    "mode": "BASE",
    "spinsRemaining": 0,
    "heatLevel": 1
  }
}
```

### Notes on fields
- ‘totalWinX’ MUST be defined as: totalWinX = totalWin / betAmount (base bet). Base bet is betAmount (not including ante surcharge from hype mode).
- Each ‘winLine.winX’ MUST be defined as: winX = amount / betAmount (base bet).
- `capReason` values:
  - `"max_win_base"`
  - `"max_win_bonus"`
  - `"max_exposure"`

### Event ordering (MUST)
Client MUST play events in the order returned.
Typical ordering:
1. optional eventStart (event boundaries that begin this round)
2. reveal
3. optional base modifiers (spotlightWilds)
4. win presentation (winLine / winWays if used)
5. mode transitions (enterFreeSpins) if applicable
6. progression (heatUpdate) if applicable
7. bonus closure (bonusEnd) if applicable
8. optional eventEnd (event boundaries that end this round)
9. celebration (winTier) if applicable

---

## 3) Error Response (all endpoints)

Server MUST return machine-readable error body:

```json
{
  "protocolVersion": "1.0",
  "error": {
    "code": "INVALID_BET",
    "message": "Bet amount not allowed.",
    "recoverable": false
  }
}
```

- Client MUST ignore unknown fields (forward compatibility).
- HTTP status MUST match error_codes.md.

---

## 4) Event Payload Contract (MUST)

This section defines required fields for event objects in `events[]`.

### 4.1 reveal

```json
{ "type": "reveal", "grid": [[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]] }
```

### 4.2 winLine

```json
{ "type": "winLine", "lineId": 1, "amount": 1.25, "winX": 1.25 }
```

### 4.3 enterFreeSpins

```json
{ "type": "enterFreeSpins", "count": 10, "reason": "scatter" }
```

or for VIP Buy:

```json
{ "type": "enterFreeSpins", "count": 10, "reason": "buy_feature", "bonusVariant": "vip_buy" }
```

Fields:
- `count` (number): number of free spins awarded
- `reason` (string, optional): `scatter|buy_feature` - indicates trigger source
- `bonusVariant` (string, optional): `standard|vip_buy` - present only when reason is buy_feature

### 4.4 heatUpdate

```json
{ "type": "heatUpdate", "level": 1 }
```

### 4.5 eventStart / eventEnd

```json
{ "type": "eventStart", "eventType": "boost", "reason": "smallwins", "durationSpins": 3 }
```

```json
{ "type": "eventEnd", "eventType": "boost" }
```

`eventType` MUST be one of: `boost|rage|explosive|bonus|finale`

### 4.6 spotlightWilds

```json
{ "type": "spotlightWilds", "positions": [0, 7, 12], "count": 3 }
```

Positions are 0-based flattened indices for a 5x3 grid:
- `index = reelIndex * 3 + rowIndex`

### 4.7 winTier

```json
{ "type": "winTier", "tier": "mega", "winX": 75.0 }
```

`tier` MUST be one of: `none|big|mega|epic`

### 4.8 bonusEnd

```json
{ "type": "bonusEnd", "bonusType": "freespins", "finalePath": "upgrade", "totalWinX": 38.0 }
```

or for VIP Buy bonus:

```json
{
  "type": "bonusEnd",
  "bonusType": "freespins",
  "finalePath": "upgrade",
  "totalWinX": 418.0,
  "bonusVariant": "vip_buy",
  "bonusMultiplierApplied": 11,
  "totalWinXPreMultiplier": 38.0
}
```

Fields:
- `bonusType` (string): `freespins|pick|wheel|other`
- `finalePath` (string): MUST be one of `upgrade|multiplier|standard`
- `totalWinX` (number): final bonus win multiplier (after VIP multiplier if applied)
- `bonusVariant` (string, optional): `standard|vip_buy` - present for VIP Buy bonuses
- `bonusMultiplierApplied` (number, optional): multiplier applied (e.g., 11) - present for VIP Buy
- `totalWinXPreMultiplier` (number, optional): win_x before VIP multiplier - present for VIP Buy

---

## 5) Compatibility Rules (MUST)
- Unknown fields MUST be ignored by the client.
- Unknown event types MUST be ignored by the client (log + continue).
- Server MUST always include `protocolVersion` in responses.
