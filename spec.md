# SPEC.MD — Machine-Readable Dev Brief (VIP Afterparty)

> Auto-generated from law files. DO NOT edit manually.
> Source of truth: protocol_v1.md, error_codes.md, CONFIG.md, GAME_RULES.md, EVENT_SYSTEM.md, SCENARIO_V1.md, TELEMETRY.md, RNG_POLICY.md

---

## 1. Protocol (from protocol_v1.md)

### Meta
- protocolVersion: `"1.0"`
- Transport: HTTPS (production), HTTP allowed for local dev
- Required Header: X-Player-Id is mandatory; if missing/empty -> INVALID_REQUEST (400)
- Idempotency: `clientRequestId` (UUIDv4) per spin request
- Server Round ID: `roundId` (UUIDv4) generated by server

### Endpoints

#### GET /init
Response (200):
```json
{
  "protocolVersion": "1.0",
  "configuration": {
    "currency": "USD",
    "allowedBets": [0.10, 0.20, 0.50, 1.00, 2.00, 5.00, 10.00],
    "enableBuyFeature": true,
    "buyFeatureCostMultiplier": 100,
    "enableTurbo": true,
    "enableHypeModeAnteBet": true,
    "hypeModeCostIncrease": 0.25
  },
  "restoreState": null
}
```

#### POST /spin
Request:
```json
{
  "clientRequestId": "uuid-v4",
  "betAmount": 1.00,
  "mode": "NORMAL|BUY_FEATURE",
  "hypeMode": false
}
```

Response (200):
```json
{
  "protocolVersion": "1.0",
  "roundId": "uuid-v4",
  "context": { "currency": "USD" },
  "outcome": {
    "totalWin": 2.50,
    "totalWinX": 2.50,
    "isCapped": false,
    "capReason": null
  },
  "events": [...],
  "nextState": {
    "mode": "BASE|FREE_SPINS",
    "spinsRemaining": 0,
    "heatLevel": 1
  }
}
```

**Outcome field definitions (MUST):**
- `totalWin`: win amount in currency.
- `totalWinX`: win multiplier relative to **base bet**: `totalWinX = totalWin / betAmount`.
  - If `hypeMode=true`, `betAmount` is still the **base bet** (payouts are based on base bet per GAME_RULES.md).

**State field definitions (MUST):**
- `nextState.mode`:
  - `BASE` when not in free spins.
  - `FREE_SPINS` when free spins are active.
- `nextState.heatLevel`:
  - MUST always be present.
  - In `BASE`, typically `0` (heat resets after free spins).
  - In `FREE_SPINS`, MUST reflect current heat/multiplier level (1-10).

### Event Types (protocol)
| Type | Required Fields |
|------|-----------------|
| reveal | grid: int[5][3] |
| winLine | lineId, amount, winX |
| enterFreeSpins | count |
| heatUpdate | level |
| eventStart | eventType, reason, durationSpins |
| eventEnd | eventType |
| spotlightWilds | positions, count |
| winTier | tier (none\|big\|mega\|epic), winX |
| bonusEnd | bonusType, finalePath (upgrade\|multiplier\|standard), totalWinX |

---

## 2. Error Codes (from error_codes.md)

| Code | HTTP | Recoverable | Description |
|------|------|-------------|-------------|
| INVALID_REQUEST | 400 | false | Malformed JSON, missing fields |
| INVALID_BET | 400 | false | betAmount not in allowedBets |
| FEATURE_DISABLED | 409 | false | Feature disabled in config |
| INSUFFICIENT_FUNDS | 402 | true | Wallet debit rejected |
| ROUND_IN_PROGRESS | 409 | true | Concurrency lock active |
| IDEMPOTENCY_CONFLICT | 409 | false | Same clientRequestId, different payload |
| RATE_LIMIT_EXCEEDED | 429 | true | Too many requests |
| MAINTENANCE | 503 | true | Server unavailable |
| INTERNAL_ERROR | 500 | true | Unhandled exception |
| NOT_IMPLEMENTED | 501 | false | Endpoint not yet implemented |

---

## 3. Math & Caps (from CONFIG.md + GAME_RULES.md)

### Hard Limits
- `MAX_WIN_TOTAL_X = 25000` — absolute cap, no payout exceeds this

### Hype Mode (Ante Bet)
- Gate: `ENABLE_HYPE_MODE_ANTE_BET = ON`
- Cost Increase: `HYPE_MODE_COST_INCREASE = 0.25` (+25%)
- Bonus Chance Multiplier: `HYPE_MODE_BONUS_CHANCE_MULTIPLIER = 2.0`
- Payouts calculated from **base bet** (not ante total)

### Afterparty Meter (Rage Mode)
> All values from CONFIG.md (source of truth). Do not duplicate numeric values here.
- Gate: `ENABLE_AFTERPARTY_METER`
- Meter Max: `AFTERPARTY_METER_MAX`
- Spins Count: `AFTERPARTY_RAGE_SPINS`
- Multiplier: `AFTERPARTY_RAGE_MULTIPLIER`
- Meter Increments:
  - Any Win: `AFTERPARTY_METER_INC_ON_ANY_WIN`
  - Wild Present: `AFTERPARTY_METER_INC_ON_WILD_PRESENT`
  - Two Scatters: `AFTERPARTY_METER_INC_ON_TWO_SCATTERS`
- Cooldown: `AFTERPARTY_RAGE_COOLDOWN_SPINS`

### Spotlight Wilds
- Gate: `ENABLE_SPOTLIGHT_WILDS = ON`
- Frequency: `SPOTLIGHT_WILDS_FREQUENCY = 0.05` (~1 in 20 spins)

---

## 4. Event System (from EVENT_SYSTEM.md + CONFIG.md)

### Global Rate Limit
- `EVENT_MAX_RATE_PER_100_SPINS = 18`

### Event Types

| Event | Trigger | Duration | Rate Limit | Math Effect |
|-------|---------|----------|------------|-------------|
| BOOST | 4+ small wins streak (0 < win_x <= 2) | 3 spins | 8/100 | None (UX only) |
| RAGE | 8+ dead spins streak (win_x = 0) | 2 spins | 6/100 | x2 multiplier |
| EXPLOSIVE | win_x >= 5 | 1 spin | 10/100 | None (UX only) |

### Trigger Values (from CONFIG.md)
- `BOOST_TRIGGER_SMALLWINS = 4`
- `RAGE_TRIGGER_DEADSPINS = 8`
- `EXPLOSIVE_TRIGGER_WIN_X = 5`

---

## 5. Scenario Timings (from SCENARIO_V1.md)

### Normal Mode Timing Targets
- Spin cycle: 0.9–1.2s
- Win text popup (< 5x): <= 0.4s
- Win presentation (5x–20x): 0.8–1.2s
- Big Win (>= 20x): 2.5–3.5s (skippable)
- Event FX: <= 0.5s (skippable)

### UX Modes
- `POST_SPIN_BOUNCE_DEFAULT = ON`
- `REDUCE_MOTION_DEFAULT = OFF`
- `TURBO_SPIN_DEFAULT = OFF`
- `ALLOW_SKIP_ANIMATIONS = ON`

### Finale Paths (Bonus End)
| Path | Condition | Effect |
|------|-----------|--------|
| upgrade | heatLevel reached MAX_HEAT_MULT | +3 Encore Spins |
| multiplier | big win (win_x >= 20) in bonus | x2 final multiplier |
| standard | fallback | Normal end |

---

## 6. Telemetry (from TELEMETRY.md)

### Required Events
| Event | Required Fields |
|-------|-----------------|
| spin_start | mode, reduce_motion, config_hash |
| spin_result | win_x, is_bonus, anticipation_used, spotlight_used, spotlight_count, teaser_used, teaser_type, hype_mode_enabled, mode, reduce_motion, config_hash |
| setting_changed | reduce_motion, turbo_spin, post_spin_bounce |
| animation_skipped | type, mode, reduce_motion |
| session_summary | spins_count, turbo_ratio, reduce_motion_ratio, avg_spin_loop_ms |
| event_start | type, reason, mode, reduce_motion, config_hash |
| event_end | type, mode, reduce_motion, config_hash |
| bonus_triggered | bonus_type, config_hash |
| bonus_end | bonus_type, total_win_x, finale_path, config_hash |

### Rage Mode Fields (per round)
- afterparty_meter_before, afterparty_meter_after
- rage_active, rage_spins_left, rage_multiplier
- rage_deferred_due_to_bonus

---

## 7. RNG Policy (from RNG_POLICY.md)

### Modes
- **Production**: Cryptographically secure, no fixed seed
- **Test/Simulation**: Deterministic, seed must be logged

### Reproducibility Requirements
- Seed passed explicitly via CLI/env/config
- Config snapshot logged (including MAX_WIN_TOTAL_X)
- Two runs with same seed + config_hash = identical results

---

## 8. Idempotency & Locking (from error_codes.md)

### Redis Idempotency
- Same `clientRequestId` → return cached response
- Same `clientRequestId` + different payload → `IDEMPOTENCY_CONFLICT` (409)

### Per-Player Lock
- Concurrent spin for same player → `ROUND_IN_PROGRESS` (409)
- Client retries with same requestId, backoff 500ms, max 3 attempts

---

## 9. Reference Docs

- `stake_docs/INDEX.md` — Stake Engine documentation index
- `stake_docs/extracted/COMPLIANCE_CHECKLIST.md` — MUST/MUST NOT rules
- `stake_docs/extracted/PIPELINE_GATES.md` — CI/dev gate commands

---

## Quick Validation Gates

```bash
make up && curl -s http://localhost:8000/health | jq -e '(.ok==true) or (.status=="ok")' >/dev/null && make down
```

# Gate 2: Tests Green
make test  # All tests must pass. No skipped tests in: contract, idempotency, locking, rng snapshots

# Gate 3: Contract Compliance
# /init and /spin responses must match protocol_v1.md exactly
# Error responses must match error_codes.md

# Gate 4: Integrity
# Same clientRequestId → identical cached response
# Concurrent spins → ROUND_IN_PROGRESS (409)
# No payout exceeds MAX_WIN_TOTAL_X = 25000
